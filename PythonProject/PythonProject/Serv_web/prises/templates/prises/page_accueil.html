{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Contrôle des LEDs</title>
    <link rel="stylesheet" type="text/css" href="{% static 'prises/style.css' %}">
</head>
<body>
    <h1 style="text-align:center;">Contrôle des LEDs</h1>

    <div class="container">
        {% for prise in prises %}
            <div class="led-box">
                <div class="led-title">{{ prise.nom }}</div>

                <!-- État actuel -->
                <div class="etat">
                    État :
                    <span id="etat-led-{{ prise.id }}">
                        {% if prise.etat %}
                            <span class="etat-on">Allumée</span>
                        {% else %}
                            <span class="etat-off">Éteinte</span>
                        {% endif %}
                    </span>
                </div>

                <!-- Boutons ON / OFF -->
                <div>
                    <a href="{% url 'set_prise_state' prise.id 'on' %}">
                        <button class="btn btn-on">Allumer</button>
                    </a>
                    <a href="{% url 'set_prise_state' prise.id 'off' %}">
                        <button class="btn btn-off">Éteindre</button>
                    </a>
                </div>

                <!-- Gestion de la plage horaire -->
                <div class="prise-card">
                    <form method="post" action="{% url 'set_horaire' prise.id %}" class="horaire-form">
                        {% csrf_token %}
                        <label>Heure d’allumage :</label>
                        <input type="time" name="heure_on" value="{{ prise.heure_on|default_if_none:'' }}">

                        <label>Heure d’extinction :</label>
                        <input type="time" name="heure_off" value="{{ prise.heure_off|default_if_none:'' }}">

                        <button type="submit" class="btn btn-primary">Enregistrer la plage horaire</button>
                    </form>
                    {% if prise.heure_on and prise.heure_off %}
                        <p>Prochaine plage horaire : de {{ prise.heure_on|time:'H:i' }} à {{ prise.heure_off|time:'H:i' }}</p>
                    {% elif prise.horaire_active %}
                        <p>Plage active mais heures non définies.</p>
                    {% else %}
                        <p>Aucune plage horaire active.</p>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Bouton global LEDs -->
    <div style="text-align:center; margin:20px;">
    	{% if prises %}
        <button id="btn-toggle-all" class="btn btn-off">Charger...</button>
    	{% endif %}
    </div>

    <!-- Panneau température -->
    <div class="container">
        <div class="led-box">
            <h1>Panneau température</h1>
            <p class="temperature">Température actuelle : <span id="temperature">{{ temperature }}</span> °C</p>
        </div>
    </div>

    <a href="{% url 'logout' %}"><button class="btn btn-off">Se déconnecter</button></a>

    <!-- Scripts -->
    <script>
        function updateTemperature() {
            fetch('/temperature-api/')
                .then(res => res.json())
                .then(data => {
                    const tempElem = document.getElementById('temperature');
                    if (tempElem) tempElem.textContent = data.temperature;
                })
                .catch(err => console.error("Erreur température :", err));
        }

        setInterval(updateTemperature, 3000);
        updateTemperature();

        function updateLedStates() {
            fetch('/etat/')
                .then(res => res.json())
                .then(data => {
                    data.forEach(prise => {
                        const etatElem = document.getElementById('etat-led-' + prise.id);
                        if (etatElem) {
                            etatElem.innerHTML = prise.etat
                                ? '<span class="etat-on">Allumée</span>'
                                : '<span class="etat-off">Éteinte</span>';
                        }
                    });
                })
                .catch(err => console.error("Erreur LEDs :", err));
        }

        updateLedStates();
        setInterval(updateLedStates, 1000);

	function updateAllButton() {
	    fetch('/etat/')
		.then(res => res.json())
		.then(data => {
		    const btn = document.getElementById('btn-toggle-all');
		    if (!btn) return;

		    const allOn = data.every(prise => prise.etat === true);

		    btn.textContent = allOn ? "Éteindre toutes les LEDs" : "Allumer toutes les LEDs";
		    btn.className = allOn ? "btn btn-on" : "btn btn-off";

		    btn.onclick = () => {
		        fetch("{% url 'toggle_all_leds' %}")
		            .then(() => updateAllButton()) // refresh après le toggle
		            .catch(err => console.error(err));
		    };
		})
		.catch(err => console.error("Erreur updateAllButton :", err));
	}

	updateAllButton();
	setInterval(updateAllButton, 1000);

    </script>
</body>
</html>
