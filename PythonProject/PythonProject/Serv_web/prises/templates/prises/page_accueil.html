{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Contr√¥le des LEDs</title>
    <link rel="stylesheet" type="text/css" href="{% static 'prises/style.css' %}">
</head>
<body>
    <h1 style="text-align:center;">Contr√¥le des LEDs</h1>

    <div class="container">
        {% for prise in prises %}
            <div class="led-box">
                <div class="led-title">{{ prise.nom }}</div>

                <!-- √âtat actuel -->
                <div class="etat">
                    √âtat :
                    <span id="etat-led-{{ prise.id }}">
                        {% if prise.etat %}
                            <span class="etat-on">Allum√©e</span>
                        {% else %}
                            <span class="etat-off">√âteinte</span>
                        {% endif %}
                    </span>
                </div>

                <!-- Boutons ON / OFF -->
                <div>
                    <a href="{% url 'set_prise_state' prise.id 'on' %}">
                        <button class="btn btn-on">Allumer</button>
                    </a>
                    <a href="{% url 'set_prise_state' prise.id 'off' %}">
                        <button class="btn btn-off">√âteindre</button>
                    </a>
                </div>

                <!-- Gestion de la plage horaire -->
                <div class="prise-card">
                    <form method="post" action="{% url 'set_horaire' prise.id %}" class="horaire-form">
                        {% csrf_token %}
                        <label>Heure d‚Äôallumage :</label>
                        <input type="time" name="heure_on" value="{{ prise.heure_on|default_if_none:'' }}">

                        <label>Heure d‚Äôextinction :</label>
                        <input type="time" name="heure_off" value="{{ prise.heure_off|default_if_none:'' }}">

                        <button type="submit" class="btn btn-primary">Enregistrer la plage horaire</button>
                    </form>
                    {% if prise.heure_on and prise.heure_off %}
                        <p>Prochaine plage horaire : de {{ prise.heure_on|time:'H:i' }} √† {{ prise.heure_off|time:'H:i' }}</p>
                    {% elif prise.horaire_active %}
                        <p>Plage active mais heures non d√©finies.</p>
                    {% else %}
                        <p>Aucune plage horaire active.</p>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Bouton global LEDs -->
    <div style="text-align:center; margin:20px;">
        {% if prises %}
            <a href="{% url 'toggle_all_leds' %}">
                {% if all_on %}
                    <button class="btn btn-on">üí° √âteindre toutes les LEDs</button>
                {% else %}
                    <button class="btn btn-off">üí° Allumer toutes les LEDs</button>
                {% endif %}
            </a>
        {% endif %}
    </div>

    <!-- Panneau temp√©rature -->
    <div class="container">
        <div class="led-box">
            <h1>Panneau temp√©rature</h1>
            <p class="temperature">Temp√©rature actuelle : <span id="temperature">{{ temperature }}</span> ¬∞C</p>
        </div>
    </div>

    <a href="{% url 'logout' %}"><button class="btn btn-off">Se d√©connecter</button></a>

    <!-- Scripts -->
    <script>
        // Mise √† jour de la temp√©rature toutes les 3 secondes
        function updateTemperature() {
            fetch('/temperature-api/')
                .then(res => res.json())
                .then(data => {
                    const tempElem = document.getElementById('temperature');
                    if (tempElem) tempElem.textContent = data.temperature;
                });
        }
        setInterval(updateTemperature, 3000);
        updateTemperature();

        // Mise √† jour des √©tats des LEDs toutes les secondes
        function updateLedStates() {
            fetch('/etat/')
                .then(res => res.json())
                .then(data => {
                    data.forEach(prise => {
                        const etatElem = document.getElementById('etat-led-' + prise.id);
                        if (etatElem) {
                            etatElem.innerHTML = prise.etat
                                ? '<span class="etat-on">Allum√©e</span>'
                                : '<span class="etat-off">√âteinte</span>';
                        }
                    });
                });
        }
    </script>
    // Appel initial
updateLedStates();

// Rafra√Æchissement toutes les 1 seconde
setInterval(updateLedStates, 1000);

</body>
</html>

